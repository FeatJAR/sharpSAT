<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>component_cache-inl.h</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*
 * component_cache-inl.h
 *
 *  Created on: Aug 23, 2012
 *      Author: Marc Thurley
 */

#ifndef SHARP_SAT_COMPONENT_CACHE_INL_H_
#define SHARP_SAT_COMPONENT_CACHE_INL_H_

namespace sharpSAT {

<span style = "background-color:#dfd">CacheEntryID ComponentCache::storeAsEntry(CacheableComponent &amp;ccomp, CacheEntryID super_comp_id){</span>
    CacheEntryID id;

<span style = "background-color:#dfd">    if (statistics_.cache_full())</span>
<span style = "background-color:#fdd">        deleteEntries();</span>

<span style = "background-color:#dfd">    assert(!statistics_.cache_full());</span>

<span style = "background-color:#dfd">    ccomp.set_creation_time(my_time_++);</span>

<span style = "background-color:#dfd">    if (free_entry_base_slots_.empty()) {
        if (entry_base_.capacity() == entry_base_.size()) {</span>
<span style = "background-color:#fdd">            entry_base_.reserve(2 * entry_base_.size());</span>
        }
<span style = "background-color:#dfd">        entry_base_.push_back(&amp;ccomp);
        id = entry_base_.size() - 1;
    } else {
        id = free_entry_base_slots_.back();
        assert(id &lt; entry_base_.size());
        assert(entry_base_[id] == nullptr);
        free_entry_base_slots_.pop_back();
        entry_base_[id] = &amp;ccomp;</span>
    }

<span style = "background-color:#dfd">    entry(id).set_father(super_comp_id);
    add_descendant(super_comp_id, id);</span>

<span style = "background-color:#dfd">    assert(hasEntry(id));
    assert(hasEntry(super_comp_id));</span>

<span style = "background-color:#dfd">    statistics_.incorporate_cache_store(ccomp);</span>

  #ifdef DEBUG
      for (unsigned u = 2; u &lt; entry_base_.size(); u++)
            if (entry_base_[u] != nullptr) {
              assert(entry_base_[u]-&gt;father() != id);
              assert(entry_base_[u]-&gt;first_descendant() != id);
              assert(entry_base_[u]-&gt;next_sibling() != id);
            }
  #endif
<span style = "background-color:#dfd">    return id;
}</span>

<span style = "background-color:#dfd">void ComponentCache::cleanPollutionsInvolving(CacheEntryID id) {
  CacheEntryID father = entry(id).father();
  if (entry(father).first_descendant() == id) {
    entry(father).set_first_descendant(entry(id).next_sibling());
  } else {
    CacheEntryID act_sibl = entry(father).first_descendant();
    while (act_sibl) {
      CacheEntryID next_sibl = entry(act_sibl).next_sibling();
      if (next_sibl == id) {
        entry(act_sibl).set_next_sibling(entry(next_sibl).next_sibling());
        break;</span>
      }
<span style = "background-color:#dfd">      act_sibl = next_sibl;
    }</span>
  }
<span style = "background-color:#dfd">  CacheEntryID next_child = entry(id).first_descendant();
  entry(id).set_first_descendant(0);
  while (next_child) {
    CacheEntryID act_child = next_child;
    next_child = entry(act_child).next_sibling();
    cleanPollutionsInvolving(act_child);
  }
  removeFromHashTable(id);
  eraseEntry(id);
}</span>

<span style = "background-color:#dfd">void ComponentCache::removeFromHashTable(CacheEntryID id) {</span>
  //assert(false);
<span style = "background-color:#dfd">  unsigned act_id = table_[tableEntry(id)];
  if(act_id == id){
    table_[tableEntry(id)] = entry(act_id).next_bucket_element();</span>
  }
<span style = "background-color:#dfd">  else {
  while (act_id) {</span>
<span style = "background-color:#fdd">        CacheEntryID next_id = entry(act_id).next_bucket_element();
        if (next_id == id) {
          entry(act_id).set_next_bucket_element(entry(next_id).next_bucket_element());
          break;</span>
        }
<span style = "background-color:#fdd">        act_id = next_id;
      }</span>
  }
//  CacheBucket *p_bucket = bucketOf(entry(id));
//  if(p_bucket)
//    for (auto it = p_bucket-&gt;begin(); it != p_bucket-&gt;end(); it++)
//      if (*it == id) {
//        *it = p_bucket-&gt;back();
//        p_bucket-&gt;pop_back();
//        break;
//      }
<span style = "background-color:#dfd">}</span>

<span style = "background-color:#fdd">void ComponentCache::removeFromDescendantsTree(CacheEntryID id) {
  assert(hasEntry(id));</span>
  // we need a father for this all to work
<span style = "background-color:#fdd">  assert(entry(id).father());
  assert(hasEntry(entry(id).father()));</span>
  // two steps
  // 1. remove id from the siblings list
<span style = "background-color:#fdd">  CacheEntryID father = entry(id).father();
  if (entry(father).first_descendant() == id) {
    entry(father).set_first_descendant(entry(id).next_sibling());
  } else {
    CacheEntryID act_sibl = entry(father).first_descendant();
    while (act_sibl) {
      CacheEntryID next_sibl = entry(act_sibl).next_sibling();
      if (next_sibl == id) {
        entry(act_sibl).set_next_sibling(entry(next_sibl).next_sibling());
        break;</span>
      }
<span style = "background-color:#fdd">      act_sibl = next_sibl;
    }</span>
  }

  // 2. add the children of this one as
  //    siblings to the current siblings
<span style = "background-color:#fdd">  CacheEntryID act_child = entry(id).first_descendant();
  while (act_child) {
    CacheEntryID next_child = entry(act_child).next_sibling();
    entry(act_child).set_father(father);
    entry(act_child).set_next_sibling(entry(father).first_descendant());
    entry(father).set_first_descendant(act_child);
    act_child = next_child;
  }
}</span>

<span style = "background-color:#dfd">void ComponentCache::storeValueOf(CacheEntryID id, const mpz_class &amp;model_count) {
  considerCacheResize();
  unsigned table_ofs = tableEntry(id);</span>
  // when storing the new model count the size of the model count
  // and hence that of the component will change
<span style = "background-color:#dfd">  statistics_.sum_bytes_cached_components_ -= entry(id).SizeInBytes();
  statistics_.overall_bytes_components_stored_ -= entry(id).SizeInBytes();</span>

<span style = "background-color:#dfd">  statistics_.sys_overhead_sum_bytes_cached_components_ -= entry(id).sys_overhead_SizeInBytes();
  statistics_.sys_overhead_overall_bytes_components_stored_ -= entry(id).sys_overhead_SizeInBytes();</span>

<span style = "background-color:#dfd">  entry(id).set_model_count(model_count,my_time_);
  entry(id).set_creation_time(my_time_);</span>

<span style = "background-color:#dfd">  entry(id).set_next_bucket_element(table_[table_ofs]);
  table_[table_ofs] = id;</span>

<span style = "background-color:#dfd">  statistics_.sum_bytes_cached_components_ += entry(id).SizeInBytes();
  statistics_.overall_bytes_components_stored_ += entry(id).SizeInBytes();</span>

<span style = "background-color:#dfd">  statistics_.sys_overhead_sum_bytes_cached_components_ += entry(id).sys_overhead_SizeInBytes();
   statistics_.sys_overhead_overall_bytes_components_stored_ += entry(id).sys_overhead_SizeInBytes();</span>

<span style = "background-color:#dfd">}</span>
} // sharpSAT namespace
#endif /* COMPONENT_CACHE_INL_H_ */</pre>
	</body>
</html>